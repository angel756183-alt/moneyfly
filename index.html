<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="éŒ¢éŒ¢é£›èµ°äº†">
  <meta name="theme-color" content="#dc2626">
  <title>éŒ¢éŒ¢é£›èµ°äº†</title>
  
  <!-- PWA Icons -->
  <link rel="icon" type="image/png" href="money-bouquet.png">
  <link rel="apple-touch-icon" href="money-bouquet.png">
  <link rel="manifest" href="manifest.json">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
  </style>
</head>
<script>
    // è¨»å†Š PWA Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((reg) => console.log('Service Worker è¨»å†ŠæˆåŠŸ', reg))
          .catch((err) => console.log('Service Worker è¨»å†Šå¤±æ•—', err));
      });
    }

    // åŸæœ¬çš„ç¨‹å¼ç¢¼...
    const currencies = { ... (ç•¥)
  </script>
</body>
<body class="bg-gradient-to-br from-red-50 to-green-50 min-h-screen p-4">
  <div class="max-w-md mx-auto">
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-4">
      <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">
        ğŸ„ éŒ¢éŒ¢é£›èµ°äº† ğŸ…
      </h1>

      <!-- åŸåƒ¹è¼¸å…¥ -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">å•†å“åŸåƒ¹</label>
        <div class="relative">
          <span class="absolute left-3 top-3 text-gray-400">$</span>
          <input type="number" id="originalPrice" placeholder="è¼¸å…¥åŸåƒ¹"
            class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:border-red-500 focus:outline-none text-lg">
        </div>
        <select id="currency" class="mt-2 w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-red-500 focus:outline-none">
          <option value="TWD">NT$ å°å¹£</option>
          <option value="USD">$ ç¾å…ƒ</option>
          <option value="EUR">â‚¬ æ­å…ƒ</option>
          <option value="JPY">Â¥ æ—¥åœ“</option>
          <option value="CNY">Â¥ äººæ°‘å¹£</option>
          <option value="HKD">HK$ æ¸¯å¹£</option>
          <option value="GBP">Â£ è‹±éŠ</option>
          <option value="NZD">NZ$ ç´è¥¿è˜­å¹£</option>
          <option value="EGP">EÂ£ åŸƒåŠéŠ</option>
          <option value="SEK">kr ç‘å…¸å…‹æœ—</option>
          <option value="NOK">kr æŒªå¨å…‹æœ—</option>
          <option value="DKK">kr ä¸¹éº¥å…‹æœ—</option>
          <option value="AUD">A$ æ¾³å¹£</option>
          <option value="VND">â‚« è¶Šå—ç›¾</option>
          <option value="THB">à¸¿ æ³°éŠ–</option>
        </select>
      </div>

      <!-- æŠ˜æ‰£è¼¸å…¥ -->
      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <label class="block text-sm font-medium text-gray-700">å¥—ç”¨æŠ˜æ‰£</label>
          <button onclick="addDiscount()" class="flex items-center gap-1 text-red-600 text-sm font-medium hover:text-red-700">
            <span>+</span> æ–°å¢æŠ˜æ‰£
          </button>
        </div>
        <div id="discountList"></div>
      </div>

      <!-- æ»¿é¡è´ˆè¼¸å…¥ -->
      <div class="mb-6 border-t-2 border-gray-100 pt-6">
        <div class="flex justify-between items-center mb-2">
          <label class="block text-sm font-medium text-gray-700 flex items-center gap-2">
            ğŸ æ»¿é¡è´ˆ
          </label>
          <button onclick="addGiftThreshold()" class="flex items-center gap-1 text-green-600 text-sm font-medium hover:text-green-700">
            <span>+</span> æ–°å¢é–€æª»
          </button>
        </div>
        <div id="giftList"></div>
        <p class="text-xs text-gray-500 mt-2">ä¾‹å¦‚ï¼šæ»¿ 3000 é€ 300</p>
      </div>

      <!-- è¨ˆç®—çµæœ -->
      <div id="result"></div>

      <!-- åŒ¯ç‡è½‰æ› -->
      <div id="exchangeSection" class="border-t-2 border-gray-100 pt-4 hidden">
        <label class="block text-sm font-medium text-gray-700 mb-2">åŒ¯ç‡è½‰æ›</label>
        <select id="targetCurrency" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-red-500 focus:outline-none mb-3">
        </select>
        <div id="exchangeResult"></div>
      </div>
    </div>

    <div class="text-center text-sm text-gray-600">
      <p>æç¤ºï¼šæŠ˜æ‰£æ•¸å­—ä»£è¡¨æ‰“å¹¾æŠ˜</p>
      <p>ä¾‹å¦‚ï¼š80 = æ‰“8æŠ˜ï¼ˆåŸåƒ¹çš„80%ï¼‰</p>
    </div>
  </div>

  <script>
    const currencies = {
      'TWD': { name: 'å°å¹£', symbol: 'NT$' },
      'USD': { name: 'ç¾å…ƒ', symbol: '$' },
      'EUR': { name: 'æ­å…ƒ', symbol: 'â‚¬' },
      'JPY': { name: 'æ—¥åœ“', symbol: 'Â¥' },
      'CNY': { name: 'äººæ°‘å¹£', symbol: 'Â¥' },
      'HKD': { name: 'æ¸¯å¹£', symbol: 'HK$' },
      'GBP': { name: 'è‹±éŠ', symbol: 'Â£' },
      'NZD': { name: 'ç´è¥¿è˜­å¹£', symbol: 'NZ$' },
      'EGP': { name: 'åŸƒåŠéŠ', symbol: 'EÂ£' },
      'SEK': { name: 'ç‘å…¸å…‹æœ—', symbol: 'kr' },
      'NOK': { name: 'æŒªå¨å…‹æœ—', symbol: 'kr' },
      'DKK': { name: 'ä¸¹éº¥å…‹æœ—', symbol: 'kr' },
      'AUD': { name: 'æ¾³å¹£', symbol: 'A$' },
      'VND': { name: 'è¶Šå—ç›¾', symbol: 'â‚«' },
      'THB': { name: 'æ³°éŠ–', symbol: 'à¸¿' }
    };

    let discounts = [{ id: 1, value: '' }];
    let giftThresholds = [{ id: 1, spend: '', gift: '' }];
    let exchangeRate = null;

    function addDiscount() {
      discounts.push({ id: Date.now(), value: '' });
      renderDiscounts();
    }

    function removeDiscount(id) {
      if (discounts.length > 1) {
        discounts = discounts.filter(d => d.id !== id);
        renderDiscounts();
        calculate();
      }
    }

    function addGiftThreshold() {
      giftThresholds.push({ id: Date.now(), spend: '', gift: '' });
      renderGifts();
    }

    function removeGiftThreshold(id) {
      if (giftThresholds.length > 1) {
        giftThresholds = giftThresholds.filter(g => g.id !== id);
        renderGifts();
        calculate();
      }
    }

    function renderDiscounts() {
      const list = document.getElementById('discountList');
      list.innerHTML = discounts.map((d, index) => `
        <div class="flex items-center gap-2 mb-3">
          <div class="flex-1 relative">
            <input type="number" value="${d.value}" 
              onchange="discounts[${index}].value = this.value; calculate();"
              placeholder="ç¬¬ ${index + 1} æ¬¡æŠ˜æ‰£ (ä¾‹å¦‚: 80 ä»£è¡¨æ‰“8æŠ˜)"
              class="w-full pl-4 pr-10 py-3 border-2 border-gray-200 rounded-lg focus:border-red-500 focus:outline-none"
              min="0" max="100">
            <span class="absolute right-3 top-3 text-gray-400">%</span>
          </div>
          ${discounts.length > 1 ? `
            <button onclick="removeDiscount(${d.id})" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">âœ•</button>
          ` : ''}
        </div>
      `).join('');
    }

    function renderGifts() {
      const list = document.getElementById('giftList');
      list.innerHTML = giftThresholds.map((g, index) => `
        <div class="mb-3">
          <div class="flex items-center gap-2">
            <input type="number" value="${g.spend}"
              onchange="giftThresholds[${index}].spend = this.value; calculate();"
              placeholder="æ»¿é¡é‡‘é¡"
              class="flex-1 px-2 py-2 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none text-sm">
            <span class="text-gray-500 text-sm">é€</span>
            <input type="number" value="${g.gift}"
              onchange="giftThresholds[${index}].gift = this.value; calculate();"
              placeholder="è´ˆé€é‡‘é¡"
              class="flex-1 px-2 py-2 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none text-sm">
            ${giftThresholds.length > 1 ? `
              <button onclick="removeGiftThreshold(${g.id})" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">âœ•</button>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    function calculate() {
      const originalPrice = parseFloat(document.getElementById('originalPrice').value) || 0;
      if (!originalPrice) {
        document.getElementById('result').innerHTML = '';
        document.getElementById('exchangeSection').classList.add('hidden');
        return;
      }

      const currency = document.getElementById('currency').value;
      const symbol = currencies[currency].symbol;

      // è¨ˆç®—æŠ˜æ‰£
      let steps = [{ label: 'åŸåƒ¹', price: originalPrice, discount: null }];
      let currentPrice = originalPrice;

      discounts.forEach((d, index) => {
        const discountValue = parseFloat(d.value);
        if (discountValue && discountValue > 0 && discountValue <= 100) {
          currentPrice = currentPrice * (discountValue / 100);
          steps.push({
            label: `ç¬¬ ${index + 1} æ¬¡æŠ˜æ‰£`,
            price: currentPrice,
            discount: discountValue
          });
        }
      });

      // è¨ˆç®—æ»¿é¡è´ˆ
      const validThresholds = giftThresholds
        .filter(g => parseFloat(g.spend) > 0 && parseFloat(g.gift) > 0 && currentPrice >= parseFloat(g.spend))
        .sort((a, b) => parseFloat(b.spend) - parseFloat(a.spend));

      const bestThreshold = validThresholds[0];
      const giftAmount = bestThreshold ? parseFloat(bestThreshold.gift) : 0;
      const finalPrice = currentPrice - giftAmount;
      const totalDiscount = ((1 - finalPrice / originalPrice) * 100).toFixed(1);

      // é¡¯ç¤ºè¨ˆç®—éç¨‹
      let stepsHtml = steps.length > 1 ? `
        <div class="bg-gradient-to-r from-red-50 to-green-50 rounded-xl p-4 mb-4">
          <h3 class="text-sm font-semibold text-gray-700 mb-3">è¨ˆç®—éç¨‹</h3>
          ${steps.map(s => `
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm text-gray-600">${s.label}${s.discount ? ` (${s.discount}æŠ˜)` : ''}</span>
              <span class="font-semibold text-gray-800">${symbol} ${s.price.toFixed(2)}</span>
            </div>
          `).join('')}
          ${giftAmount > 0 ? `
            <div class="flex justify-between items-center mb-2 text-green-600">
              <span class="text-sm flex items-center gap-1">ğŸ æ»¿é¡è´ˆæŠ˜æŠµ</span>
              <span class="font-semibold">- ${symbol} ${giftAmount.toFixed(2)}</span>
            </div>
          ` : ''}
        </div>
      ` : '';

      // é¡¯ç¤ºæœ€çµ‚çµæœ
      document.getElementById('result').innerHTML = `
        ${stepsHtml}
        <div class="bg-gradient-to-r from-red-600 to-green-600 rounded-xl p-5 text-white mb-4">
          <div class="text-sm opacity-90 mb-1">å¯¦ä»˜é‡‘é¡</div>
          <div class="text-3xl font-bold mb-2">${symbol} ${finalPrice.toFixed(2)}</div>
          <div class="text-sm opacity-90">
            å…±çœä¸‹ ${totalDiscount}% (${symbol} ${(originalPrice - finalPrice).toFixed(2)})
          </div>
          ${bestThreshold ? `
            <div class="mt-2 pt-2 border-t border-white border-opacity-30 text-sm">
              âœ¨ å·²å¥—ç”¨ï¼šæ»¿ ${bestThreshold.spend} é€ ${bestThreshold.gift}
            </div>
          ` : ''}
        </div>
      `;

      // é¡¯ç¤ºåŒ¯ç‡è½‰æ›å€
      document.getElementById('exchangeSection').classList.remove('hidden');
      updateTargetCurrencies(currency);
      fetchExchangeRate(finalPrice);
    }

    function updateTargetCurrencies(currentCurrency) {
      const select = document.getElementById('targetCurrency');
      select.innerHTML = Object.keys(currencies)
        .filter(code => code !== currentCurrency)
        .map(code => `<option value="${code}">${currencies[code].symbol} ${currencies[code].name}</option>`)
        .join('');
    }

    async function fetchExchangeRate(finalPrice) {
      const currency = document.getElementById('currency').value;
      const targetCurrency = document.getElementById('targetCurrency').value;
      
      if (currency === targetCurrency) return;

      document.getElementById('exchangeResult').innerHTML = '<div class="text-center text-gray-500 py-2">è¼‰å…¥åŒ¯ç‡ä¸­...</div>';

      try {
        const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${currency}`);
        const data = await response.json();
        exchangeRate = data.rates[targetCurrency];
        
        const convertedPrice = finalPrice * exchangeRate;
        const targetSymbol = currencies[targetCurrency].symbol;

        document.getElementById('exchangeResult').innerHTML = `
          <div class="bg-red-50 rounded-lg p-4">
            <div class="text-sm text-gray-600 mb-1">
              åŒ¯ç‡: 1 ${currency} = ${exchangeRate.toFixed(4)} ${targetCurrency}
            </div>
            <div class="text-2xl font-bold text-red-600">
              ${targetSymbol} ${convertedPrice.toFixed(2)}
            </div>
          </div>
        `;
      } catch (error) {
        document.getElementById('exchangeResult').innerHTML = '<div class="text-center text-red-500 py-2">è¼‰å…¥åŒ¯ç‡å¤±æ•—</div>';
      }
    }

    // åˆå§‹åŒ–
    renderDiscounts();
    renderGifts();
    
    // ç›£è½è¼¸å…¥è®ŠåŒ–
    document.getElementById('originalPrice').addEventListener('input', calculate);
    document.getElementById('currency').addEventListener('change', calculate);
    document.getElementById('targetCurrency').addEventListener('change', () => {
      const finalPrice = parseFloat(document.getElementById('originalPrice').value) || 0;
      if (finalPrice) fetchExchangeRate(finalPrice);
    });
  </script>
</body>
</html>

